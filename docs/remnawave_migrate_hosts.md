# remnawave_migrate_hosts

–†–æ–ª—å `remnawave_migrate_hosts` –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –º–∏–≥—Ä–∞—Ü–∏—é **Host‚Äë–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π** –∏–∑ Marzban –≤ Remnawave, —Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤).

–≠—Ç–æ –≤—Ç–æ—Ä–æ–π –∫–ª—é—á–µ–≤–æ–π —ç—Ç–∞–ø –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ Reality‚Äëinbound‚Äôa.

---

## üéØ –¶–µ–ª—å —Ä–æ–ª–∏

–í Marzban —Ö–æ—Å—Ç—ã (`hosts`) ‚Äî —ç—Ç–æ —Å–ø–∏—Å–æ–∫ –¥–æ–º–µ–Ω–æ–≤ –∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

–†–æ–ª—å:

1. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ö–æ—Å—Ç–æ–≤ –∏–∑ Marzban.
2. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (remark, path, host, sni, fingerprint, alpn, securityLayer –∏ —Ç.–¥.).
3. –°–æ–∑–¥–∞—ë—Ç –∏—Ö –≤ Remnawave, –ø—Ä–∏–≤—è–∑—ã–≤–∞—è –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É inbound‚Äô—É.
4. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç **–∏–¥–µ–∞–ª—å–Ω—É—é –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**:
   - –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤;
   - –∫–∞–∂–¥—ã–π host –º–∏–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑.

---

## üìå –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

–î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ö–æ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç—Ä–æ–≥–∏–π –∏ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–ª—é—á:

```
address|port
```

–ü–æ—á–µ–º—É —Ç–∞–∫:

- `address` —É–Ω–∏–∫–∞–ª–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: *edge-ams-01.digitalstreamers.xyz*)
- `port` –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ 443
- `remark` –ø–ª–æ—Ö–æ –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Äî –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—Ä–µ–∑–∞–Ω Remnawave –∏–ª–∏ —Å–ª–µ–≥–∫–∞ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–∏—Å—Ç–µ–º–∞–º–∏

–ü–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ —Ä–æ–ª–∏:

- –≤—Å–µ —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ `address|port` –ø–æ–ø–∞–¥–∞—é—Ç –≤ `_mh_existing_host_keys`
- –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π Marzban‚Äë—Ö–æ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø–æ –∫–ª—é—á—É
- –µ—Å–ª–∏ host —É–∂–µ –µ—Å—Ç—å ‚Äî –æ–Ω **–ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è**

---

## üì¶ –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–æ–ª—å

### 1. –ß–∏—Ç–∞–µ—Ç —Ö–æ—Å—Ç—ã –∏–∑ Marzban

–ß–µ—Ä–µ–∑:

```
GET /api/hosts
```

> ‚ö†Ô∏è –ü–æ–ª—è –≤ Marzban –º–æ–≥—É—Ç –±—ã—Ç—å null, –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî —Ä–æ–ª—å –∏—Ö –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç.

### 2. –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ö–æ—Å—Ç—ã Remnawave

–ß–µ—Ä–µ–∑:

```
GET /api/hosts
```

Important: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–≥–æ:

```json
{ "response": [ {...}, {...} ] }
```

–ü–æ—ç—Ç–æ–º—É —Å–ø–∏—Å–æ–∫ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∫–∞–∫:

```yaml
_mh_rw_hosts_list: "{{ _mh_rw_hosts_raw.json.response | default([]) }}"
```

### 3. –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è

–†–æ–ª—å –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –≤–∏–¥—É:

- `remark` (–Ω–µ –±–æ–ª–µ–µ 40 —Å–∏–º–≤–æ–ª–æ–≤)
- `sni` ‚Üí address, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
- `host` ‚Üí host ‚Üí sni ‚Üí address
- `path` ‚Üí "/" –µ—Å–ª–∏ null
- `alpn` ‚Üí omit, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
- `fingerprint` ‚Üí omit, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
- `allowInsecure` ‚Üí boolean
- `securityLayer` ‚Üí STRICT enum: `DEFAULT`, `TLS`, `NONE`

### 4. –°–æ–±–∏—Ä–∞–µ—Ç CreateHostRequestDto

–° –ø–æ–ª—è–º–∏:

```yaml
inbound:
  configProfileUuid: ...
  configProfileInboundUuid: ...

address: ...
port: ...
remark: ...
host: ...
sni: ...
path: ...
alpn: <omit>
fingerprint: <omit>
securityLayer: DEFAULT
allowInsecure: false
```

### 5. –°–æ–∑–¥–∞—ë—Ç —Ö–æ—Å—Ç –≤ Remnawave (–µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç)

```
POST /api/hosts
```

---

## üß™ –†–µ–∂–∏–º Dry‚ÄëRun

–í –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π:

```yaml
remnawave_migrate_hosts_dry_run: true
```

–†–æ–ª—å:

- –Ω–µ –¥–µ–ª–∞–µ—Ç PATCH/POST
- —Ç–æ–ª—å–∫–æ –≤—ã–≤–æ–¥–∏—Ç:
  - –ø—Ä–æ–ø—É—Å–∫–∏: `Skip existing host: ...`
  - –±—É–¥—É—â–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è: `DRY-RUN: show host body to create`

---

## üîß –í—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–û–±—ã—á–Ω–æ –∑–∞–¥–∞—é—Ç—Å—è –≤ `group_vars/panel.yml`.

### –û—Å–Ω–æ–≤–Ω—ã–µ

```yaml
# Marzban API
marzban_api_base_url: "https://marzban-s2.vpn-for-friends.com:4443"
marzban_api_token: ""
marzban_admin_username: "admin"
marzban_admin_password: "changeme"

# Remnawave API
remnawave_api_base_url: "https://{{ remnawave_panel_frontend_domain }}/api"
remnawave_panel_api_token: "rw_xxx"

# –ö–∞–∫–æ–π inbound –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å –∫ —Ö–æ—Å—Ç–∞–º
remnawave_migrate_hosts_target_inbound_tag: "VLESS TCP REALITY"

# Dry‚Äërun
remnawave_migrate_hosts_dry_run: true
```

---

## ‚ñ∂Ô∏è –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### –û–¥–∏–Ω —Ä–∞–∑ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å:

```bash
make migrate-hosts
```

–∏–ª–∏:

```bash
make migrate-hosts EXTRA='-e remnawave_migrate_hosts_dry_run=false'
```

### Dry‚Äërun:

```bash
make migrate-hosts EXTRA='-e remnawave_migrate_hosts_dry_run=true'
```

---

## üß± –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ —Ä–æ–ª—å –≤–Ω—É—Ç—Ä–∏

### –®–∞–≥–∏:

1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Marzban (–µ—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç)
2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ö–æ—Å—Ç–æ–≤ –∏–∑ Marzban
3. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ö–æ—Å—Ç–æ–≤ –∏–∑ Remnawave
4. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ `_mh_existing_host_keys` (`address|port`)
5. –î–ª—è –∫–∞–∂–¥–æ–≥–æ Marzban‚Äëhost:
   - –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
   - –ø—Ä–æ–≤–µ—Ä–∫–∞ idempotency
   - dry‚Äërun / create host
6. –õ–æ–≥-—Å–≤–æ–¥–∫–∞

---

## üõ°Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–æ–ª–∏

- –†–æ–ª—å **–Ω–µ —É–¥–∞–ª—è–µ—Ç** —Ö–æ—Å—Ç—ã –≤ Remnawave
- –†–æ–ª—å **–Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ** —Ö–æ—Å—Ç—ã (—Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–µ)
- –†–æ–ª—å –Ω–µ –º–∏–≥—Ä–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ä–æ–ª—å
- –†–æ–ª—å –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç –Ω–æ–¥—ã ‚Äî –±—É–¥–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø

---

## üìò –ü—Ä–∏–º–µ—Ä Playbook

`playbooks/migrate_hosts.yml`:

```yaml
---
- name: Migrate Marzban hosts to Remnawave
  hosts: panel
  gather_facts: false
  roles:
    - role: remnawave_migrate_hosts
```

---

## üìÑ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏

- `remnawave_migrate_inbound`
- `remnawave_migrate_users` (–±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º)
- `remnawave_node` (—Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–æ–¥)
- `remnawave_add_host` (—Ä—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞)
