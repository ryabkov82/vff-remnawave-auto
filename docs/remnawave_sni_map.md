# üì¶ –†–æ–ª—å `remnawave_sni_map`

–†–æ–ª—å –≤—ã—á–∏—Å–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ **SNI ‚Üí –ø–æ—Ä—Ç XRAY** –¥–ª—è –Ω–æ–¥—ã Remnawave.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
- `roles/haproxy_tls_sni` ‚Äî –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∏ –Ω–æ–¥–∞ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
- `roles/remnawave_node_haproxy` ‚Äî –µ—Å–ª–∏ –Ω–æ–¥–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ

–†–æ–ª—å **–Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** –∏ **–Ω–µ –≤–Ω–æ—Å–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º—É** ‚Äî –æ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤—ã—á–∏—Å–ª—è–µ—Ç
—Å–ª—É–∂–µ–±–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö `_sni_port_map`.

---

## üöÄ –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ —Ä–æ–ª–∏

–ü–æ–ª—É—á–∏—Ç—å –æ—Ç –ø–∞–Ω–µ–ª–∏ Remnawave –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≤—ã—á–∏—Å–ª–∏—Ç—å:

```yaml
_sni_port_map:
  <fqdn>: <port>
  ...
```

–ü—Ä–∏–º–µ—Ä:

```yaml
_sni_port_map:
  edge-fra-01.digitalstreamers.xyz: 8445
  stream-fra-01.digitalstreamers.xyz: 8445
  cache-fra-01.digitalstreamers.xyz: 8445
  segment-fra-01.digitalstreamers.xyz: 8445
```

–≠—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ –¥–∞–ª–µ–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö ACL
(SNI-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏) –≤ HAProxy.

---

## üì• –í—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `remnawave_api_base_url` | URL API Remnawave, –Ω–∞–ø—Ä–∏–º–µ—Ä `https://panel.example.com/api` |
| `remnawave_panel_api_token` | API‚Äë—Ç–æ–∫–µ–Ω –ø–∞–Ω–µ–ª–∏ |
| `remnawave_node_uuid` | UUID –Ω–æ–¥—ã *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* |
| `remnawave_sni_node_name` | –ò–º—è –Ω–æ–¥—ã *(–µ—Å–ª–∏ UUID –Ω–µ —É–∫–∞–∑–∞–Ω)* |
| `remnawave_sni_map_debug` | –í–∫–ª—é—á–∞–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ *(–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: false)* |
| `remnawave_hosts` | –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫ Host‚Äë–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è exclude‚Äë–ª–æ–≥–∏–∫–∏) |

–ü–æ—Ä—è–¥–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–¥—ã:

```
1) remnawave_node_uuid (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
2) remnawave_sni_node_name
3) inventory_hostname
```

---

## üì§ –í—ã—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
|------------|------------|
| `_sni_port_map` | –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `{ sni ‚Üí port }` |

–ï—Å–ª–∏ –Ω–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Ä–æ–ª—å **–Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π** –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```yaml
_sni_port_map: {}
```

–≠—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π.

---

## üîß –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ä–æ–ª–∏

### 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ UUID –Ω–æ–¥—ã

- –ï—Å–ª–∏ `remnawave_node_uuid` –∑–∞–¥–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é.
- –ò–Ω–∞—á–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è `GET /api/nodes` –∏ –ø–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏.

–ï—Å–ª–∏ –Ω–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Ä–æ–ª—å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –ø—É—Å—Ç–æ–π –∫–∞—Ä—Ç–æ–π.

---

### 2. –ß—Ç–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–æ–¥—ã

```
GET /api/nodes/<uuid>
```

–ò–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–±–∞—É–Ω–¥–æ–≤:

```
response.configProfile.activeInbounds[].uuid
```

---

### 3. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∏–Ω–±–∞—É–Ω–¥–æ–≤ –ø–∞–Ω–µ–ª–∏

```
GET /api/config-profiles/inbounds
```

–§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞:

```
inbound_uuid ‚Üí inbound_object
```

---

### 4. –ó–∞–≥—Ä—É–∑–∫–∞ host‚Äë–æ–≤

```
GET /api/hosts
```

–û—Å—Ç–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ host‚Äë—ã, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ —Ç–µ–∫—É—â–µ–π –Ω–æ–¥–µ:

```
host.nodes contains node_uuid
```

---

### 5. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `inbound_uuid ‚Üí port`

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω–±–∞—É–Ω–¥–∞ –ø–æ—Ä—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:

1. `rawInbound.listen.port`
2. `inbound.port`
3. –µ—Å–ª–∏ –ø–æ—Ä—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω ‚Äî –∏–Ω–±–∞—É–Ω–¥ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

---

### 6. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ SNI ‚Üí PORT

–î–ª—è –∫–∞–∂–¥–æ–≥–æ host:

- –µ—Å–ª–∏ `include_in_sni_map: false` ‚Äî host **–∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è**
- –∏–Ω–∞—á–µ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ SNI:

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ SNI:

1. `host.sni` (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)
2. `rawInbound.streamSettings.realitySettings.serverNames`

–î–ª—è –∫–∞–∂–¥–æ–≥–æ SNI –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:

```
sni ‚Üí port
```

–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è—Ö.

---

## üß™ –û—Ç–ª–∞–¥–∫–∞

–í–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–∫–∏:

```yaml
remnawave_sni_map_debug: true
```

–í—ã–≤–æ–¥–∏—Ç:

- resolved UUID –Ω–æ–¥—ã
- —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–±–∞—É–Ω–¥–æ–≤
- —Å–ø–∏—Å–æ–∫ host‚Äë–æ–≤
- –∏—Ç–æ–≥–æ–≤—ã–π `_sni_port_map`

---

## üöÄ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```yaml
- include_role:
    name: remnawave_sni_map

- name: Render haproxy.cfg
  template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
```

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è:

```yaml
_sni_port_map:
  edge-fra-01.digitalstreamers.xyz: 8445
```

---

## ‚úî –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–æ–¥—ã

–ï—Å–ª–∏ –Ω–æ–¥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–æ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ —Ö–æ—Å—Ç–µ —Å –ø–∞–Ω–µ–ª—å—é):

```yaml
_sni_port_map: {}
```

–ò—Å–ø–æ–ª—å–∑—É—é—â–∞—è —Ä–æ–ª—å —Å–∞–º–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ ‚Äî
–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ª–∏ XRAY‚ÄëSNI –±–ª–æ–∫–∏.

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT  
–ß–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ **VFF Remnawave Auto Deployment**
