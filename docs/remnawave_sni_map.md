# üì¶ –†–æ–ª—å `remnawave_sni_map`

–†–æ–ª—å –≤—ã—á–∏—Å–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ **SNI ‚Üí –ø–æ—Ä—Ç XRAY** –¥–ª—è –Ω–æ–¥—ã Remnawave.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
- `roles/haproxy_tls_sni` ‚Äî –µ—Å–ª–∏ –ø–∞–Ω–µ–ª—å –∏ –Ω–æ–¥–∞ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ  
- `roles/remnawave_node_haproxy` ‚Äî –µ—Å–ª–∏ –Ω–æ–¥–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ö–æ—Å—Ç–µ

–†–æ–ª—å –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–æ–Ω—Ñ–∏–≥–æ–≤ ‚Äî –æ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤—ã—á–∏—Å–ª—è–µ—Ç `_sni_port_map`.

---

# üöÄ –û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ —Ä–æ–ª–∏

–ü–æ–ª—É—á–∏—Ç—å –æ—Ç –ø–∞–Ω–µ–ª–∏ Remnawave –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –≤—ã—á–∏—Å–ª–∏—Ç—å:

```yaml
_sni_port_map:
  <fqdn>: <port>
  ...
```

–ù–∞–ø—Ä–∏–º–µ—Ä:

```yaml
{
  "edge-fra-01.digitalstreamers.xyz": 8445,
  "stream-fra-01.digitalstreamers.xyz": 8445,
  "cache-fra-01.digitalstreamers.xyz": 8445,
  "segment-fra-01.digitalstreamers.xyz": 8445
}
```

–≠—Ç–∞ —Ç–∞–±–ª–∏—Ü–∞ –∑–∞—Ç–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö ACL
(SNI-–º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏) –≤ HAProxy.

---

# üì• –í—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

–†–æ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç:

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `remnawave_api_base_url` | URL API Remnawave, –Ω–∞–ø—Ä–∏–º–µ—Ä `https://panel.example.com/api` |
| `remnawave_panel_api_token` | API-—Ç–æ–∫–µ–Ω –ø–∞–Ω–µ–ª–∏ |
| `remnawave_node_uuid` | UUID –Ω–æ–¥—ã *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* |
| `remnawave_node_name` | –ò–º—è –Ω–æ–¥—ã, –µ—Å–ª–∏ UUID –Ω–µ —É–∫–∞–∑–∞–Ω *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* |
| `remnawave_sni_map_debug` | –í–∫–ª—é—á–∞–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥ *(–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: false)* |

–î–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–¥—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

```
1) remnawave_node_uuid (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
2) remnawawave_node_name
3) inventory_hostname
```

---

# üì§ –í—ã—Ö–æ–¥–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è | –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ |
|------------|------------|
| `_sni_port_map` | –§–∏–Ω–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ `{ sni ‚Üí port }` |

–ï—Å–ª–∏ –Ω–æ–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî —Ä–æ–ª—å –ù–ï –ø–∞–¥–∞–µ—Ç, –∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:

```yaml
_sni_port_map: {}
```

---

# üîß –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Ä–æ–ª–∏

## 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ UUID –Ω–æ–¥—ã

- –ï—Å–ª–∏ `remnawave_node_uuid` —É–∫–∞–∑–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º.
- –ò–Ω–∞—á–µ –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å `/api/nodes` –∏ –∏—â–µ–º –ø–æ –∏–º–µ–Ω–∏.

## 2. –ß—Ç–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–æ–¥—ã

–ó–∞–ø—Ä–æ—Å:

```
GET /api/nodes/<uuid>
```

–∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–±–∞—É–Ω–¥–æ–≤:

```
response.configProfile.activeInbounds
```

## 3. –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∏–Ω–±–∞—É–Ω–¥–æ–≤ –ø–∞–Ω–µ–ª–∏

```
GET /api/config-profiles/inbounds
```

–°–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞—Ä—Ç–∞:

```
_inb_map = { inboundUuid ‚Üí inboundObject }
```

## 4. –ü–æ–ª—É—á–µ–Ω–∏–µ hosts

```
GET /api/hosts
```

–§–∏–ª—å—Ç—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –Ω–æ–¥–µ:

```
host.nodes contains nodeUuid
```

## 5. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ inbound_uuid ‚Üí port

–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:

1) `rawInbound.listen.port`  
2) `port`  
3) –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–Ω–±–∞—É–Ω–¥ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

## 6. –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ SNI

SNI —Ö–æ—Å—Ç–∞:

```
host.sni.split(',')
```

SNI –∏–Ω–±–∞—É–Ω–¥–∞:

```
rawInbound.streamSettings.realitySettings.serverNames
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–Ω–æ–∂–µ—Å—Ç–≤:

```
host_sni ‚à© inbound_sni
```

---

# üß™ –û—Ç–ª–∞–¥–∫–∞

–í–∫–ª—é—á–µ–Ω–∏–µ:

```yaml
remnawave_sni_map_debug: true
```

–í—ã–≤–æ–¥–∏—Ç:

- –Ω–∞–π–¥–µ–Ω–Ω—ã–π UUID –Ω–æ–¥—ã  
- —Å–ø–∏—Å–æ–∫ –∏–Ω–±–∞—É–Ω–¥–æ–≤  
- –Ω–∞–π–¥–µ–Ω–Ω—ã–µ SNI  
- –∏—Ç–æ–≥–æ–≤—ã–π `_sni_port_map`

---

# üöÄ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```yaml
- include_role:
    name: remnawave_sni_map

- name: Render haproxy.cfg
  template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
```

–ü–æ—Å–ª–µ —á–µ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–∞:

```yaml
_sni_port_map:
  edge-fra-01.digitalstreamers.xyz: 8445
  ...
```

---

# ‚úî –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –Ω–æ–¥—ã

–ï—Å–ª–∏ –Ω–æ–¥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ —Ö–æ—Å—Ç–µ —Å –ø–∞–Ω–µ–ª—å—é).

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ:

```yaml
_sni_port_map: {}
```

–ò—Å–ø–æ–ª—å–∑—É—é—â–∞—è —Ä–æ–ª—å —Å–∞–º–∞ —Ä–µ—à–∞–µ—Ç ‚Äî –¥–æ–±–∞–≤–ª—è—Ç—å –±–ª–æ–∫ XRAY –∏–ª–∏ –Ω–µ—Ç.

---

# üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT  
–ß–∞—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ **VFF Remnawave Auto Deployment**.
