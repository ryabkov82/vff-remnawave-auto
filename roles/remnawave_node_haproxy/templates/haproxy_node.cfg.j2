global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 50s
    timeout server 50s

frontend https_in
    bind :443
    mode tcp

    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }
    tcp-request content capture req.ssl_sni len 255

    # ============================================================
    # XRAY dynamic routing via SNI
    # ============================================================

    {% for sni, port in _sni_port_map.items() %}
    acl SNI_XRAY_{{ loop.index }} req.ssl_sni -i {{ sni }}
    use_backend be_xray_{{ port }} if SNI_XRAY_{{ loop.index }}
    {% endfor %}

    # Default route â†’ nginx
    default_backend be_nginx

backend be_nginx
    mode tcp
    server nginx_local {{ nginx_https_bind }} check

{% for port in _sni_port_map.values() | unique %}
backend be_xray_{{ port }}
    mode tcp
    server xray_local 127.0.0.1:{{ port }} check
{% endfor %}

listen stats
    bind 127.0.0.1:1936
    mode http
    stats enable
    stats uri /haproxy-stats
    stats realm HAProxy\ Statistics
    stats auth admin:StrongPa$$
