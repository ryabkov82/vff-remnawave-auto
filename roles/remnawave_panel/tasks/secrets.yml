---
- name: Stat existing .env
  ansible.builtin.stat:
    path: "{{ remnawave_panel_dir }}/.env"
  register: _env_stat
  tags: [panel, secrets]

- name: Load existing .env (if present)
  ansible.builtin.slurp:
    path: "{{ remnawave_panel_dir }}/.env"
  register: _env_raw
  when: _env_stat.stat.exists
  tags: [panel, secrets]

- name: Make list of lines from .env
  ansible.builtin.set_fact:
    _env_lines: >-
      {{
        (_env_raw.content | default('') | b64decode).splitlines()
        if _env_stat.stat.exists else []
      }}
  tags: [panel, secrets]

# Build a dict of current values from .env for selected keys
- name: Extract existing values from .env into a dict
  ansible.builtin.set_fact:
    _env_current: >-
      {{
        (_env_current | default({}))
        | combine({
            (item): (
              _env_lines
              | select('match', '^' ~ item ~ '=')
              | list | first | default('')
              | regex_replace('^' ~ item ~ '=', '')
              | regex_replace('^\\s*\"|\"\\s*$', '')
              | regex_replace('\\r$', '')
            )
          })
      }}
  loop:
    - POSTGRES_PASSWORD
    - JWT_AUTH_SECRET
    - JWT_API_TOKENS_SECRET
    - METRICS_USER
    - METRICS_PASS
    - WEBHOOK_SECRET_HEADER
  tags: [panel, secrets]

# Reuse values from .env when available
- name: Reuse values from existing .env where available
  ansible.builtin.set_fact:
    remnawave_panel_pg_password: >-
      {{ _env_current['POSTGRES_PASSWORD']
         | default(remnawave_panel_pg_password, true) }}
    remnawave_panel_jwt_auth_secret: >-
      {{ _env_current['JWT_AUTH_SECRET']
         | default(remnawave_panel_jwt_auth_secret, true) }}
    remnawave_panel_jwt_api_tokens_secret: >-
      {{ _env_current['JWT_API_TOKENS_SECRET']
         | default(remnawave_panel_jwt_api_tokens_secret, true) }}
    remnawave_panel_metrics_user: >-
      {{ _env_current['METRICS_USER']
         | default(remnawave_panel_metrics_user | default('admin'), true) }}
    remnawave_panel_metrics_pass: >-
      {{ _env_current['METRICS_PASS']
         | default(remnawave_panel_metrics_pass, true) }}
    remnawave_panel_webhook_secret_header: >-
      {{ _env_current['WEBHOOK_SECRET_HEADER']
         | default(remnawave_panel_webhook_secret_header, true) }}
  tags: [panel, secrets]

# Generate only what is still empty
- name: Generate Postgres password if empty (hex 48)
  ansible.builtin.set_fact:
    remnawave_panel_pg_password: >-
      {{ lookup('password', '/dev/null length=48 chars=hexdigits') | lower }}
  when: (remnawave_panel_pg_password | default('')) | length == 0
  tags: [panel, secrets]

- name: Generate JWT auth secret if empty (hex 64)
  ansible.builtin.set_fact:
    remnawave_panel_jwt_auth_secret: >-
      {{ lookup('password', '/dev/null length=64 chars=hexdigits') | lower }}
  when: (remnawave_panel_jwt_auth_secret | default('')) | length == 0
  tags: [panel, secrets]

- name: Generate JWT API tokens secret if empty (hex 64)
  ansible.builtin.set_fact:
    remnawave_panel_jwt_api_tokens_secret: >-
      {{ lookup('password', '/dev/null length=64 chars=hexdigits') | lower }}
  when: (remnawave_panel_jwt_api_tokens_secret | default('')) | length == 0
  tags: [panel, secrets]

- name: Default metrics user to 'admin' if empty
  ansible.builtin.set_fact:
    remnawave_panel_metrics_user: "admin"
  when: (remnawave_panel_metrics_user | default('')) | length == 0
  tags: [panel, secrets]

- name: Generate metrics password if empty (hex 64)
  ansible.builtin.set_fact:
    remnawave_panel_metrics_pass: >-
      {{ lookup('password', '/dev/null length=64 chars=hexdigits') | lower }}
  when: (remnawave_panel_metrics_pass | default('')) | length == 0
  tags: [panel, secrets]

- name: Generate webhook secret if enabled and empty (exact 64)
  ansible.builtin.set_fact:
    remnawave_panel_webhook_secret_header: >-
      {{ lookup('password', '/dev/null length=64 chars=ascii_letters,digits') }}
  when:
    - remnawave_panel_webhook_enabled | default(false) | bool
    - (remnawave_panel_webhook_secret_header | default('')) | length == 0
  tags: [panel, secrets]
