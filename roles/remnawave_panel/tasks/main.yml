- name: Check required variables
  ansible.builtin.import_tasks: check.yml

- name: Ensure install directory exists
  ansible.builtin.file:
    path: "{{ remnawave_panel_dir }}"
    state: directory
    owner: "{{ remnawave_panel_user }}"
    group: "{{ remnawave_panel_group }}"
    mode: "0755"

- name: Generate secrets
  ansible.builtin.import_tasks: secrets.yml

- name: Render .env from template (upstream sample + our overrides)
  ansible.builtin.template:
    src: env.j2
    dest: "{{ remnawave_panel_dir }}/.env"
    owner: "{{ remnawave_panel_user }}"
    group: "{{ remnawave_panel_group }}"
    mode: "0640"
  notify: Restart remnawave stack

- name: Render docker-compose.yml
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ remnawave_panel_dir }}/docker-compose.yml"
    owner: "{{ remnawave_panel_user }}"
    group: "{{ remnawave_panel_group }}"
    mode: "0644"
  notify: Restart remnawave stack

- name: Ensure Remnawave stack is up (compose v2)
  community.docker.docker_compose_v2:
    project_src: "{{ remnawave_panel_dir }}"
    state: present
    pull: always
    remove_orphans: true

- name: Wait for health endpoint (metrics)
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ remnawave_panel_metrics_port }}/health"
    method: GET
    status_code: 200
    url_username: "{{ remnawave_panel_metrics_user | default(omit) }}"
    url_password: "{{ remnawave_panel_metrics_pass | default(omit) }}"
    force_basic_auth: true
    timeout: 5
  register: _health
  retries: 60
  delay: 3
  until: _health.status == 200

- name: Set helpful facts for smoke tests
  ansible.builtin.set_fact:
    remnawave_panel_health_url: "http://127.0.0.1:{{ remnawave_panel_metrics_port }}/health"
    remnawave_panel_metrics_url: "http://127.0.0.1:{{ remnawave_panel_metrics_port }}/metrics"
