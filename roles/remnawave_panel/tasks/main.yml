---
- name: Create panel dir
  ansible.builtin.file:
    path: "{{ panel_compose_dir }}"
    state: directory
    mode: '0755'
  tags: [panel]

- name: Drop docker-compose.yml
  ansible.builtin.copy:
    dest: "{{ panel_compose_dir }}/docker-compose.yml"
    mode: '0644'
    content: |
      version: "3.8"
      services:
        nginx:
          image: nginx:alpine
          volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf:ro
            - /var/lib/remnawave-panel:/var/lib/remnawave-panel:ro
          network_mode: host
          restart: unless-stopped
        panel:
          image: remnawave/panel:{{ remnawave_version }}
          env_file: .env
          volumes:
            - /var/lib/remnawave-panel:/var/lib/remnawave-panel
          network_mode: host
          restart: unless-stopped
  tags: [panel]

- name: Drop nginx.conf
  ansible.builtin.copy:
    dest: "{{ panel_compose_dir }}/nginx.conf"
    mode: '0644'
    content: |
      events {}
      http {
        server {
          listen {{ panel_internal_https_port }} ssl;
          ssl_certificate     {{ panel_tls_cert }};
          ssl_certificate_key {{ panel_tls_key }};
          location / {
            proxy_pass http://127.0.0.1:8080;
          }
        }
      }
  tags: [panel]

- name: Ensure panel stack is up
  community.docker.docker_compose_v2:
    project_src: "{{ panel_compose_dir }}"
    state: present
  tags: [panel]
