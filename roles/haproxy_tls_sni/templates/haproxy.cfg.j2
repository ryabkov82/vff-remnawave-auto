global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    mode tcp
    log  global
    option tcplog
    option dontlognull
    option srvtcpka
    option clitcpka
    timeout connect {{ haproxy_timeout_connect }}
    timeout client  {{ haproxy_timeout_client }}
    timeout server  {{ haproxy_timeout_server }}
    timeout client-fin {{ haproxy_timeout_client_fin }}
    timeout server-fin {{ haproxy_timeout_server_fin }}
    timeout tunnel {{ haproxy_timeout_tunnel }}

frontend https_in
    bind {{ haproxy_bind_addr }}:{{ haproxy_bind_port }}
    mode tcp
    option tcplog

    tcp-request inspect-delay {{ haproxy_inspect_delay }}
    tcp-request content accept if { req_ssl_hello_type 1 }
    tcp-request content capture req.ssl_sni len 256

    # =====================
    # PANEL / SUBSCRIPTION
    # =====================

    {% set _panel_domain = remnawave_panel_frontend_domain | default(haproxy_panel_domain) %}

    {% set _sub_domains = [] %}
    {% if remnawave_sub_public_domain is defined
          and (remnawave_group_subscription is not defined
               or remnawave_group_subscription not in groups) %}
        {% set _sub_domains = [remnawave_sub_public_domain] %}
    {% endif %}

    {% set _extra_domains = haproxy_nginx_sni_domains | default([]) %}
    {% set _nginx_domains = ([_panel_domain] + _sub_domains + _extra_domains) | unique %}

    acl SNI_PANEL req.ssl_sni -i {{ _nginx_domains | join(' ') }}

    {% set _node_domains = haproxy_node_nginx_sni_domains | default([]) %}
    {% if _node_domains | length > 0 %}

    acl SNI_NODE_NGINX req.ssl_sni -i {{ _node_domains | join(' ') }}

    {% endif %}

    # =====================
    # XRAY (dynamic SNI routing)
    # =====================

    {% for sni, port in _sni_port_map.items() %}

    acl SNI_XRAY_{{ loop.index }} req.ssl_sni -i {{ sni }}
    use_backend be_xray_{{ port }} if SNI_XRAY_{{ loop.index }}

    {% endfor %}

    # =====================
    # Default routing
    # =====================
    {% if _node_domains | length > 0 %}

    use_backend be_node_nginx if SNI_NODE_NGINX

    {% endif %}

    use_backend be_panel if SNI_PANEL
    default_backend be_node_nginx

backend be_panel
    mode tcp
    option srvtcpka
    server nginx_local {{ haproxy_nginx_host }}:{{ haproxy_nginx_port }} check

backend be_node_nginx
    mode tcp
    option srvtcpka
    server node_nginx_local {{ haproxy_node_nginx_host }}:{{ haproxy_node_nginx_port }} check

{% for port in _sni_port_map.values() | unique %}
backend be_xray_{{ port }}
    mode tcp
    option srvtcpka
    server xray_local 127.0.0.1:{{ port }} send-proxy-v2
{% endfor %}

{% if haproxy_stats_enabled %}
listen stats
    bind {{ haproxy_stats_bind }}
    mode http
    stats enable
    stats realm HAProxy\ Statistics
    stats uri {{ haproxy_stats_uri }}
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_pass }}
{% endif %}
