---
- name: Assert required variables
  ansible.builtin.assert:
    that:
      - haproxy_panel_domain | length > 0
      - haproxy_bind_port   | int > 0
      - haproxy_nginx_port  | int > 0
      - haproxy_xray_port   | int > 0
      - remnawave_api_base_url | length > 0
      - remnawave_panel_api_token | length > 0
    fail_msg: "Missing required vars: haproxy_panel_domain/nginx_port/xray_port/API token."
  tags: [haproxy]


# =====================================================================
# BUILD SNI MAP
# =====================================================================

- name: Build SNIâ†’PORT map using remnawave_sni_map
  ansible.builtin.include_role:
    name: remnawave_sni_map
  vars:
    remnawave_sni_node_name: "{{ remnawave_node_name | default(inventory_hostname) }}"
    remnawave_sni_api_base_url: "{{ remnawave_api_base_url }}"
    remnawave_sni_api_token: "{{ remnawave_panel_api_token }}"
  tags: ['sni_map']

- name: Install HAProxy
  ansible.builtin.apt:
    name: haproxy
    state: present
    update_cache: true

# =====================================================================
# 7) Render haproxy.cfg
# =====================================================================

- name: Render haproxy.cfg
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: "{{ haproxy_cfg_path }}"
    owner: root
    group: root
    mode: "0644"
    validate: "haproxy -c -f %s"
  notify: HAProxy Reconfigure

- name: Ensure HAProxy is started
  ansible.builtin.service:
    name: haproxy
    enabled: true
    state: started

- name: Flush handlers
  ansible.builtin.meta: flush_handlers
