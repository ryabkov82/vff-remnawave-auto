---
- name: Assert required variables
  ansible.builtin.assert:
    that:
      - haproxy_panel_domain | length > 0
      - haproxy_bind_port   | int > 0
      - haproxy_nginx_port  | int > 0
      - haproxy_xray_port   | int > 0
    fail_msg: "haproxy_panel_domain/bind_port/nginx_port/xray_port must be set."
  tags: [haproxy]

- name: Install HAProxy
  ansible.builtin.apt:
    name: haproxy
    state: present
    update_cache: true
  tags: [haproxy, install]

- name: Render haproxy.cfg (TCP passthrough with SNI routing)
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: "{{ haproxy_cfg_path }}"
    owner: root
    group: root
    mode: "0644"
    validate: "haproxy -c -f %s"
  notify: HAProxy Reconfigure
  tags: [haproxy, config]

- name: Ensure HAProxy is enabled and started
  ansible.builtin.service:
    name: haproxy
    enabled: true
    state: started
  tags: [haproxy]
