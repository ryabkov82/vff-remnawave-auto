---
# Bundled: subscription page on the same host as panel (HAProxy/Nginx live here)

- name: DNS | Create/Update A record for subscription domain
  ansible.builtin.include_role:
    name: cf_dns
  vars:
    cf_dns_records:
      - type: "A"
        name: "{{ remnawave_sub_public_domain | regex_replace('\\.' ~ cf_dns_zone ~ '$', '') }}"
        proxied: false
        ttl: 300
  tags: [dns]

- name: HAProxy | Route panel+subscription SNI to Nginx
  ansible.builtin.include_role:
    name: haproxy_tls_sni
  vars:
    # Merge existing list with panel+sub domains (unique)
    haproxy_nginx_sni_domains:
      - "{{ remnawave_panel_frontend_domain | default(haproxy_panel_domain) }}"
      - "{{ remnawave_sub_public_domain }}"
  tags: [haproxy]

# Выпуск сертификата для домена подписки (поддержка HTTP-01 и DNS-01)
# Тянем только tls-задачи из роли nginx, чтобы не лезть в её vhost-логику
- name: CERT | Issue certificate for subscription domain (bundled)
  ansible.builtin.include_tasks: cert.yml
  when: remnawave_sub_public_domain is defined and remnawave_sub_public_domain|length > 0
  tags: [cert, tls]

- name: SUBPAGE | Deploy bundled subscription page
  ansible.builtin.include_role:
    name: remnawave_subscription_page
  vars:
    remnawave_sub_deploy_mode: "bundled"
  tags: [subpage]
