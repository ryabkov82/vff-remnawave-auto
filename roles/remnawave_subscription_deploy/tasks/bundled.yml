---
# Bundled: subscription page on the same host as panel (HAProxy/Nginx live here)

- name: DNS | Create/Update A record for subscription domain
  ansible.builtin.include_role:
    name: cf_dns
  vars:
    cf_dns_records:
      - type: "A"
        name: "{{ remnawave_sub_public_domain | regex_replace('\\.' ~ cf_dns_zone ~ '$', '') }}"
        proxied: false
        ttl: 300
  tags: [dns, cf_dns]

- name: DNS | Create/Update A record for legacy Marzban domain
  ansible.builtin.include_role:
    name: cf_dns
  vars:
    cf_dns_records:
      - type: "A"
        name: "{{ remnawave_sub_marzban_legacy_domain | regex_replace('\\.' ~ cf_dns_zone ~ '$', '') }}"
        proxied: false
        ttl: 300
  when:
    - remnawave_legacy_marzban_enabled | bool
    - remnawave_sub_marzban_legacy_domain is defined
    - remnawave_sub_marzban_legacy_domain | length > 0
  tags: [dns, cf_dns, legacy, marzban]

- name: HAProxy | Route panel+subscription SNI to Nginx
  ansible.builtin.include_role:
    name: haproxy_tls_sni
  tags: [haproxy]

# Выпуск сертификата для домена подписки (поддержка HTTP-01 и DNS-01)
# Тянем только tls-задачи из роли nginx, чтобы не лезть в её vhost-логику
- name: CERT | Issue certificate for subscription domain (bundled)
  ansible.builtin.include_tasks: cert.yml
  when:
    - remnawave_sub_public_domain is defined
    - remnawave_sub_public_domain | length > 0
  tags: [cert, tls]

- name: CERT | Issue certificate for legacy Marzban domain (bundled)
  ansible.builtin.include_tasks: cert_legacy.yml
  when:
    - remnawave_legacy_marzban_enabled | bool
    - remnawave_sub_marzban_legacy_domain is defined
    - remnawave_sub_marzban_legacy_domain | length > 0
  tags: [cert, tls, legacy, marzban]

- name: SUBPAGE | Deploy bundled subscription page
  ansible.builtin.include_role:
    name: remnawave_subscription_page
  vars:
    remnawave_sub_deploy_mode: "bundled"
  tags: [subpage]
