---
- name: Check required vars
  ansible.builtin.assert:
    that:
      - (nginx_server_name | length) > 0
      - >
        (not (nginx_manage_vhost | bool)) or
        ((nginx_upstream_app_port | int) > 0)
    fail_msg: >-
      nginx_server_name must be set; nginx_upstream_app_port is required when nginx_manage_vhost=true
  tags: [nginx]

- name: Install nginx and helpers
  ansible.builtin.apt:
    name: [nginx, python3-passlib, openssl]
    state: present
    update_cache: true
  tags: [nginx, install]

# Общие факты для TLS (проверка наличия LE, вычисления и т.п.)
- name: TLS | Detect existing LE certificate and set facts
  ansible.builtin.include_tasks: tls_detect.yml
  when: nginx_tls_mode in ['letsencrypt', 'letsencrypt_dns01']
  tags: [nginx, tls]

# Ветки выпуска сертификата
- name: TLS | Issue certificate via HTTP-01 (webroot)
  ansible.builtin.include_tasks: tls_http01.yml
  when: nginx_tls_mode == 'letsencrypt'
  tags: [nginx, tls]

- name: TLS | Issue certificate via DNS-01 (Cloudflare)
  ansible.builtin.include_tasks: tls_dns01.yml
  when: nginx_tls_mode == 'letsencrypt_dns01'
  tags: [nginx, tls]

- name: TLS | Generate self-signed certificate
  ansible.builtin.include_tasks: tls_selfsigned.yml
  when: nginx_tls_mode == 'selfsigned'
  tags: [nginx, tls]

# Рендер vhost (если включён)
- name: Nginx | Render and enable HTTPS vhost
  ansible.builtin.include_tasks: vhost.yml
  when: nginx_manage_vhost | bool
  tags: [nginx, config]

# Проверки (если включён vhost)
- name: Nginx | Post-deploy checks and sanity tests
  ansible.builtin.include_tasks: checks.yml
  when: nginx_manage_vhost | bool
  tags: [nginx, check]
