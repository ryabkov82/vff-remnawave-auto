---
# Вход: mu_user (элемент из /api/users Marzban)

- name: MU | Init expireAt with default
  ansible.builtin.set_fact:
    _mu_expire_at_value: "{{ _mu.default_expire_at }}"

- name: MU | Calculate expireAt from Marzban unix timestamp (if present)
  when:
    - mu_user.expire is not none
    - (mu_user.expire | int) > 0
  ansible.builtin.command:
    cmd: "date -u -d @{{ mu_user.expire | int }} +%Y-%m-%dT%H:%M:%SZ"
  register: _mu_expire_cmd
  changed_when: false

- name: MU | Override expireAt from calculated value
  when:
    - _mu_expire_cmd is defined
    - _mu_expire_cmd.stdout is defined
    - _mu_expire_cmd.stdout | length > 0
  ansible.builtin.set_fact:
    _mu_expire_at_value: "{{ _mu_expire_cmd.stdout }}"

# --------------------------------------------------------------------
# Username: повторяем sanitizeUsername из subscription-page
#   1) оставляем только [A-Za-z0-9_-], остальное → '_'
#   2) если длина < 6, добиваем '_' до 6 символов
# --------------------------------------------------------------------

- name: MU | Capture raw Marzban username
  ansible.builtin.set_fact:
    _mu_username_raw: "{{ mu_user.username | string }}"
  changed_when: false

- name: MU | Prepare base sanitized username
  ansible.builtin.set_fact:
    _mu_username_base: "{{ _mu_username_raw | regex_replace('[^A-Za-z0-9_-]', '_') }}"
  changed_when: false

- name: MU | Ensure minimum username length (>= 6 chars)
  ansible.builtin.set_fact:
    _mu_username: >-
      {{
        _mu_username_base
        if (_mu_username_base | length) >= 6
        else _mu_username_base ~ ('_' * (6 - (_mu_username_base | length)))
      }}
  changed_when: false

- name: MU | Build mapped user fields
  ansible.builtin.set_fact:
    _mu_status: "{{ status_map.get(mu_user.status, 'ACTIVE') }}"
    _mu_vless_uuid: "{{ mu_user.proxies.vless.id | default('') }}"
    _mu_expire_at: "{{ _mu_expire_at_value }}"
    _mu_traffic_limit_bytes: "{{ mu_user.data_limit | default(0, true) }}"
    _mu_traffic_strategy: >-
      {{
        strategy_map.get(
          mu_user.data_limit_reset_strategy | default('no_reset'),
          'NO_RESET'
        )
      }}
    _mu_description: "{{ mu_user.note }}"
    _mu_active_squads: >-
      {%- if _mu.assign_squad
            and _mu_internal_squad_uuid is defined
            and _mu_internal_squad_uuid | length > 0 -%}
      [ "{{ _mu_internal_squad_uuid }}" ]
      {%- else -%}
      []
      {%- endif -%}
  vars:
    status_map:
      active: "ACTIVE"
      disabled: "DISABLED"
      limited: "LIMITED"
      expired: "EXPIRED"
      on_hold: "DISABLED"
    strategy_map:
      no_reset: "NO_RESET"
      day: "DAY"
      week: "WEEK"
      month: "MONTH"
      year: "MONTH"

- name: MU | REMNAWAVE | Lookup existing user by username (SANITIZED)
  ansible.builtin.uri:
    url: "{{ _mu.api_base_url }}/users/by-username/{{ _mu_username }}"
    method: GET
    headers:
      Authorization: "Bearer {{ _mu.api_token }}"
    status_code:
      - 200
      - 404
    return_content: true
  register: _mu_rw_user_raw
  failed_when: false
  changed_when: false

- name: MU | REMNAWAVE | Normalize existing user
  ansible.builtin.set_fact:
    _mu_existing_user: "{{ _mu_rw_user_raw.json.response | default({}) }}"
    _mu_existing_exists: >-
      {{
        _mu_rw_user_raw.status == 200
        and _mu_rw_user_raw.json.response is defined
        and _mu_rw_user_raw.json.response.username is defined
      }}
  changed_when: false

- name: MU | Build create/update payloads
  ansible.builtin.set_fact:
    _mu_create_body:
      username: "{{ mu_username }}"
      status: "{{ _mu_status }}"
      expireAt: "{{ _mu_expire_at }}"
      trafficLimitBytes: "{{ _mu_traffic_limit_bytes }}"
      trafficLimitStrategy: "{{ _mu_traffic_strategy }}"
      description: "{{ _mu_description if (_mu_description is string) and (_mu_description|length > 0) else omit }}"
      activeInternalSquads: "{{ _mu_active_squads }}"
      vlessUuid: "{{ _mu_vless_uuid if (_mu_vless_uuid | length) > 0 else omit }}"
    _mu_update_body:
      username: "{{ _mu_username }}"
      uuid: "{{ _mu_existing_user.uuid | default(omit) }}"
      status: "{{ _mu_status }}"
      expireAt: "{{ _mu_expire_at }}"
      trafficLimitBytes: "{{ _mu_traffic_limit_bytes }}"
      trafficLimitStrategy: "{{ _mu_traffic_strategy }}"
      description: "{{ _mu_description }}"
      activeInternalSquads: "{{ _mu_active_squads }}"

- name: MU | DRY-RUN | Show planned action
  when: _mu.dry_run
  ansible.builtin.debug:
    msg: >-
      MU DRY-RUN for user={{ _mu_username_raw }} -> remna={{ _mu_username }}:
      existing={{ _mu_existing_exists }},
      create_body={{ _mu_create_body if not _mu_existing_exists else omit }},
      update_body={{ _mu_update_body if _mu_existing_exists else omit }}
  changed_when: false

- name: MU | REMNAWAVE | Create user
  when:
    - not _mu.dry_run
    - not _mu_existing_exists
  ansible.builtin.uri:
    url: "{{ _mu.api_base_url }}/users"
    method: POST
    headers:
      Authorization: "Bearer {{ _mu.api_token }}"
      Content-Type: "application/json"
    body_format: json
    status_code: 201
    body: "{{ _mu_create_body }}"
  register: _mu_create_resp

- name: MU | REMNAWAVE | Update user
  when:
    - not _mu.dry_run
    - _mu_existing_exists
  ansible.builtin.uri:
    url: "{{ _mu.api_base_url }}/users"
    method: PATCH
    headers:
      Authorization: "Bearer {{ _mu.api_token }}"
      Content-Type: "application/json"
    body_format: json
    status_code: 200
    body: "{{ _mu_update_body }}"
  register: _mu_update_resp

- name: MU | Summary for user
  ansible.builtin.debug:
    msg: >-
      remnawave_migrate_users:
      marzban_username={{ _mu_username_raw }},
      remna_username={{ _mu_username }},
      action={{ 'create' if (not _mu_existing_exists) else 'update' }},
      dry_run={{ _mu.dry_run }}
  changed_when: not _mu.dry_run
